import time
import math
import subprocess
import shlex
"""
 Sample program build call
    ./run.sh L1 L2 hex_string nhigh
 Core Process for test input generation:
    1) generate random input (data) with the size L1 
    2) convert random input into hex
    3) generate L2
    4) run the program once for expected output (L2==L1)
    5) run it nhigh times with random for L2
"""
nlow = 50  # number of lows
nhigh = 5  # number of highs for every low


def prepare_input(val):
    """
    "E72D_2-493"
    """
    pos1 = val.find("_")
    pos2 = val.find("-")

    hex_res = val[:pos1]
    l1 = int(val[pos1+1:pos2])
    l2 = int(val[pos2+1:])

    return l1, l2, hex_res


def process_map(mp):
    numel = 0
    for count, elem in enumerate(mp):
        val = mp[elem]
        numel += val

    total = 0
    for count, elem in enumerate(mp):
        val = mp[elem]
        prob = val / numel
        total += (-prob * math.log(prob, 2))

    return total


def calculate_entropy(omap, imap):
    res_out = process_map(omap)
    res_in = process_map(imap)

    return res_out - res_in


def exec_cmd(cmd, t_out=1):
    s_process = subprocess.Popen(
        shlex.split(cmd),
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE)
    try:
        stdout, stderr = s_process.communicate(timeout=t_out)
        return stdout.decode("ascii")
    except subprocess.TimeoutExpired:
        s_process.send_signal(9)
        return None


def get_data():
    functional = [ "35333241374232453942364639090900000012000000",
    "353332413742324539423646390909000000", 
    "4F45CD1B41001800000000000000004010000000",
    "4F45CD1B410018000000000000000040", 
    "292929292929290C29292929292929292929290606060606060606060606060606060606060606060606060629292929292929460635000000",
    "292929292929290C292929292929292929292906060606060606060606060606060606060606060606060606292929292929294606", 
    "4137422945397FFF4600000B000000",     "4137422945397FFF460000",
    "35337F000000FF090013337F0013003B0900000014000000", 
    "35337F000000FF090013337F0013003B09000000", 
    "00000000000000000000000000000000000000000015000000",   "0",
    "0000008033324132413542324539423241354242324539423241354232453942000032413542324532453942000032413542324539420000006409000000093F000000",
    "803332413241354232453942324135424232453942324135423245394200003241354232453245394200003241354232453942000000640900000009", 
    "00002B2B413742254153535353646853534137421C415353535364685353530020000000",
    "2B2B413742254153535353646853534137421C4153535353646853535300", 
    "0004E300374232324137423239092500000400003742413742323909250000040000374232324137423232413742323909090000000036000000",
    "04E3003742323241374232390925000004000037424137423239092500000400003742323241374232324137423239090900000000", 
    "0000000046445E42121D130046445E42121D130014000000",
    "46445E42121D130046445E42121D1300", 
    "00000000000000000A000000000000000000000000000017000000",
    "0A0000000000000000000000000000", 
    "007F000106FFFFFFFFDD0A000000",     "7F000106FFFFFFFFDD",
    "0000007F374220453909000B000000",   "7F37422045390900",
    "00000000000000000000000000F10900000012000000",   "F109000000",
    "0000000000000000000000000000002010000000",  "20",
    "000000000000003910000A000000",   "391000",
    "0000000000000000107F0A000000",   "107F",
    "0000000000007F0000000A000000",   "7F000000",
    "007F00130635420000000100001E4135A232453245FF000000803332411F3135A7323942324135424232453942324132453245394200001F3135333239423241354242324539423241354242324539423241324532453900001F313542323942324141324532453900001F313542323942324135424232453942000000003241355B1945394200000089000000",
    "7F00130635420000000100001E4135A232453245FF000000803332411F3135A7323942324135424232453942324132453245394200001F3135333239423241354242324539423241354242324539423241324532453900001F313542323942324141324532453900001F313542323942324135424232453942000000003241355B19453942000000", 
    "00000000000000000000000000000000000000000000000000000000000000000000F80000000027000000",
    "F800000000", 
    "007F001906FF007FDF13062A650000000100001E4135A236453245FF00000080333A411F3135A72E3942324135411F3135A732394232413541354242324539423241354242324541354242324539423241354242324539423241324532453900001F3135421F39423241414532453900001F31354232393942324141324532453900001F313542323942324135007FFF425E4135424232453942000000003241355B19A3000000",
    "7F001906FF007FDF13062A650000000100001E4135A236453245FF00000080333A411F3135A72E3942324135411F3135A732394232413541354242324539423241354242324541354242324539423241354242324539423241324532453900001F3135421F39423241414532453900001F31354232393942324141324532453900001F313542323942324135007FFF425E4135424232453942000000003241355B19", 
    "007F0001007F001906FF007EDF13062A650000000100001E4135A236453245FF00000080333A411F3135A72E3942324135411F3135A73239423241354135424232455C423241424242424242424242424242424242424242424242424242422C42424242424235424232454124424232453939423241423241354242324539423241324532453900001F31FFFFFFDD35428000000041FFFFFFFFFFFFFFDDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF4145000041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F31354232393942354141324532453900001F313542323942324135E52E2E2E2E2E2E2E2E2E2D2E2E7FFF42434135424232453942000000003209010000",
    "7F0001007F001906FF007EDF13062A650000000100001E4135A236453245FF00000080333A411F3135A72E3942324135411F3135A73239423241354135424232455C423241424242424242424242424242424242424242424242424242422C42424242424235424232454124424232453939423241423241354242324539423241324532453900001F31FFFFFFDD35428000000041FFFFFFFFFFFFFFDDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF4145000041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F31354232393942354141324532453900001F313542323942324135E52E2E2E2E2E2E2E2E2E2D2E2E7FFF424341354242324539420000000032", 
    "007F0001007F0001007F0035A236453245FF00000080333A41043135A72E394232413541043135A732394232413541354242324577423241424240004242424242424242424242EF4042424242424242422CF2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F242424242424235424232454124424232453939423341423241354242324539423241324532453900001F42424242424242424242424242424242FFFFDDFFFFFF00010000FFFFFFFFFFFFFFFFFFFFBFFFFFFF4145000041FFFFFFFFFFFFFFFF80FFFFFFFFFFFFFFFFFF32453900001F3135423239394235E841324532453900001F313542323942324135E52E2E2E2E2E2E2E2E2E2D2E2E7FFF424341354242324539420006010000",
    "7F0001007F0001007F0035A236453245FF00000080333A41043135A72E394232413541043135A732394232413541354242324577423241424240004242424242424242424242EF4042424242424242422CF2F2F2F2F2F2F2F2F2F2F2F2F2F2F2F242424242424235424232454124424232453939423341423241354242324539423241324532453900001F42424242424242424242424242424242FFFFDDFFFFFF00010000FFFFFFFFFFFFFFFFFFFFBFFFFFFF4145000041FFFFFFFFFFFFFFFF80FFFFFFFFFFFFFFFFFF32453900001F3135423239394235E841324532453900001F313542323942324135E52E2E2E2E2E2E2E2E2E2D2E2E7FFF4243413542423245394200", 
    "007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFFFFFFFF2E2EFFFFFFFFFFFFF2FFFFFFFFFFFA0000FAFFFFFFFF4144E90041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F313542363939423541413245324539FFDF1F313542323942324135E52E2E2A2E2E2E2E2E2E2D2E2E7FFF424341354242324539420003010000",
    "7F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFFFFFFFF2E2EFFFFFFFFFFFFF2FFFFFFFFFFFA0000FAFFFFFFFF4144E90041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F313542363939423541413245324539FFDF1F313542323942324135E52E2E2A2E2E2E2E2E2E2D2E2E7FFF4243413542423245394200", 
    "007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A236453245FF00000080333A411F3135A72E3942324135411F3135A73239423241354135424232455C423241424242424242424242424242424242424242424242424242422C42424242424235424232454124424232453939423241423241354242324539423241324532453900001F31FFFFFFDD35428000000041FFFFFFFFFFFFFFDDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF4145000041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F3142324135FFFFFFFFFFFFFFFFFFFFFFFFFFFFE52E2E2E2E2E2E2E2E2E2D2E2E7FFF424341354242324539420001010000",
    "7F0001007F0001007F001906FF007EDF13062A650000000100001E4135A236453245FF00000080333A411F3135A72E3942324135411F3135A73239423241354135424232455C423241424242424242424242424242424242424242424242424242422C42424242424235424232454124424232453939423241423241354242324539423241324532453900001F31FFFFFFDD35428000000041FFFFFFFFFFFFFFDDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF4145000041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F3142324135FFFFFFFFFFFFFFFFFFFFFFFFFFFFE52E2E2E2E2E2E2E2E2E2D2E2E7FFF4243413542423245394200", 
    "007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532631801000080333A41424232455C423241424242424242424242424242424242424242424242424242422C42424242424239424232454124424232453939423241423241354242324539423241324532453900001F311BFFFFDD35428000000041FFFFFFFFFFFFFFDDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF41450000413A411F3135A72E3942324135411F3135FFFFFFFFFFFFFFFFFFFFFFFFDEFFFFFFFFFF32453900001F31354232393942354141324532453900001F313542323942324135E52E2E2E2E2E2E2E2E2E2D2E2E7FFF424341354242324531420002010000",
    "7F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532631801000080333A41424232455C423241424242424242424242424242424242424242424242424242422C42424242424239424232454124424232453939423241423241354242324539423241324532453900001F311BFFFFDD35428000000041FFFFFFFFFFFFFFDDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF41450000413A411F3135A72E3942324135411F3135FFFFFFFFFFFFFFFFFFFFFFFFDEFFFFFFFFFF32453900001F31354232393942354141324532453900001F313542323942324135E52E2E2E2E2E2E2E2E2E2D2E2E7FFF4243413542423245314200", 
    "210021212121212121212121BF21212121212121212121212121212121212121212121212121000021212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121210000000000007F000021212100000000001200000000000000000000000000000000000000000000000000000000F8000000002121212121212121212121212121212121212121212121212121000000000000000000000000000000000000040000000000000000000000000000F800000000212121212121212121212121212121212121212121212121212121212121212121212121212121210000000005FFFF0500002121212121212121212121212121212121212131212121214321212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121002121212121212121212121212121212121210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFFFFFFFF2E2EFFFFFFFFFFFFF2FFFFFFFFFFFA0000FAFFFFFFFF4144E90041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F313542363939423541413245324539FFDF1F313542323942324135E52E2E2A2E2E2E21212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212131212121212121212121212121212121212121212121212121212121212100002121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121802121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212133216421212121212121212121212121212121212121212121212921212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121092121212121212121212121212121212121212121212121212121212121213DF0050000",
    "210021212121212121212121BF21212121212121212121212121212121212121212121212121000021212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121210000000000007F000021212100000000001200000000000000000000000000000000000000000000000000000000F8000000002121212121212121212121212121212121212121212121212121000000000000000000000000000000000000040000000000000000000000000000F800000000212121212121212121212121212121212121212121212121212121212121212121212121212121210000000005FFFF0500002121212121212121212121212121212121212131212121214321212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121002121212121212121212121212121212121210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFFFFFFFF2E2EFFFFFFFFFFFFF2FFFFFFFFFFFA0000FAFFFFFFFF4144E90041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F313542363939423541413245324539FFDF1F313542323942324135E52E2E2A2E2E2E21212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212131212121212121212121212121212121212121212121212121212121212100002121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121802121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212133216421212121212121212121212121212121212121212121212921212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121092121212121212121212121212121212121212121212121212121212121213D", 
    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFF00000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0000000000000000000000000000000000000000000000000000000000007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFFFFFFFF2E2EFFFFFFFFFFFFF2FFFFFFFFFFFA0000FA110000004144E90041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F313542363939423541413245324539FFDF1F313542323942324135E52E2E2A2E2E2E21212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121E80321212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212131212121212121212121212121212121212121212121212121212121212100002121212121212121212121212121212121212121212167030000",
    "0A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFF00000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0000000000000000000000000000000000000000000000000000000000007F0001007F0001007F001906FF007EDF13062A650000000100001E4135A2364532451900006480333A411F3135A73E3942324135411F3135A7323942324135413D424232455C423241424242424242424242424242424242424242422C4242424242423542421F454124424232453939423241423241354242324539423241324532453900001F31FF0AFFDD35428000000041FFFFFDFFFFFFFF2E2EFFFFFFFFFFFFF2FFFFFFFFFFFA0000FA110000004144E90041FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF32453900001F313542363939423541413245324539FFDF1F313542323942324135E52E2E2A2E2E2E21212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121E803212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121312121212121212121212121212121212121212121212121212121212121000021212121212121212121212121212121212121212121"]

    entropy = [
        "D62F6BEB04B5A7FEBB56D078E638CA45FFC00000", "D62F6BEB04B5A7FEBB56D078E638CA45FFD00000",
        "D62F6BEB04B5A7FEBB56D078E638CA45FFC00000", "D62F6BEB04B5A7FEBB56D078E638CA45FFE00000",
        "D62F6BEB04B5A7FEBB56D078E638CA45FFD00000", "06387F38F7C05FCD48A02ADC912703034B700000",
        "5FB11B0C51410CC67EED671A5872CB2380A00000", "28BBFCC4246BA6D1A84384E0A3B2417094A00000",
        "281AF5960F941BED51B70B620FC1969044200000", "121DDC1823CF57678AF4CF3344B08C74F3900000",
        "55A41917FEFEC503435E1910CE2D9C8C7ED00000", "295F679355337AE1FB51F218BC974F61FD000000",
        "7343DEBC983E43EF113BD5CA78B074BD37100000", "3DB40EC77803996244C25DD777308922A6500000",
        "20CAC98A1E92AAFA0D67742EF20F08DE53600000", "6DD8A79540B655ECBC0CCA4E4907FC1425500000",
        "13ED05211AA0235F2753CDE7503145F2EDA00000", "129878800DBCC55CBAAF458225E426C349600000",
        "3A9E8AAB6752477196023D89602CAD4DBF300000", "06B08B44BD8998E9AFA69E78633E6BE475C00000",
        "225BB5DC42642C5E869347D30DF53E7AC1500000", "2EF9749700809964D2693F5B44DFA962C5F00000",
        "3C773F5CC8D3B73C75286DAB5EA64FF2DEA00000", "2EF257FBBB5EDBAA00603C0BE03E349AE4F00000",
        "D62F6BEB04B5A7FEBB56D078E638CA4548300000", "64348F0FA83E312CE7A8C7368A40DA05F4F00000",
        "0682280849AEDF8218431D95D8072E594F600000", "1A8F273B6054F22667147553818AC7C3E6200000",
        "49E34D0264FBB9A92F35B225C27AFCB722500000", "7B18BF8A87A9050E0EACD5D9B0AB99AEDBA00000",
        "63A8774226293CB1783DEE5390009276E4D00000", "4BFC483ABD12E1A2F6C1BF6C1E3FEB6D80100000",
        "1B6FB5C0C0BBFFE9C378E7EB0C3D57FDBEB00000", "D62F6BEB04B5A7FEBB56D078E638CA4540C00000",
        "551EB38B2A63A5B0A27B5D23F67BA383D6100000", "49E49A3FAB67BEDB70FE61E6652048C945A00000",
        "51A95AE68127B981D8C709D7BABC0F3B7E300000", "D62F6BEB04B5A7FEBB56D078E638CA4535900000",
        "D62F6BEB04B5A7FEBB56D078E638CA45ADA00000", "528447A316A997A57DDA1F26C9FA1AFE80A00000"]
    return functional, entropy


def process_input():
    functional, entropy = get_data()
    total = failed = 0
    for l in range(len(functional) // 2):
        # Sample call: ./run.sh 5 19 "9E51ABF3AD" 5
        cmd = "./run.sh {} {}".format(functional[2 * l], nhigh)
        out_arr = exec_cmd(cmd)
        # print(out_arr)
        out_arr = out_arr.split(";\n")
        for h in range(len(out_arr) - 1):
            if out_arr[h] != functional[2*l + 1]:
                failed += 1

    for l in range(len(entropy)):
        omap = dict()
        imap = dict()
        istr = entropy[l]
        imap[istr] = nhigh

        # Sample call: ./run.sh 5 19 "9E51ABF3AD" 5
        cmd = "./run.sh {} {}".format(entropy[l], nhigh)
        out_arr = exec_cmd(cmd)
        out_arr = out_arr.split(";\n")
        for h in range(len(out_arr) - 1):
            ostr = istr + "^" + out_arr[h]
            if ostr in omap:
                omap[ostr] += 1
            else:
                omap[ostr] = 1

        total += calculate_entropy(omap, imap)

    return total, failed / (nlow * nhigh) * 100


if __name__ == '__main__':
    start = time.time()
    total, failed = process_input()
    print("Leak: {:.2f} Failed: {:.2f}; Time elapsed: {:.1f} seconds"
          .format(total, failed, time.time()-start))


